---
- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: Install required system packages
  apt:
    name:
      - curl
      - wget
      - git
      - python3
      - python3-pip
      - software-properties-common
    state: present

- name: Ensure timezone is set
  timezone:
    name: "{{ timezone | default('UTC') }}"

- name: Create shared directories
  file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  loop:
    - /opt/scripts
    - /var/log/myapp
    
- name: Ensure tun device is available
  command: ls /dev/net/tun
  register: tun_check
  failed_when: tun_check.rc != 0

- name: Load tun module if not loaded
  modprobe:
    name: tun
    state: present

- name: Disable unattended upgrades (optional)
  apt:
    name: unattended-upgrades
    state: absent
    purge: yes
