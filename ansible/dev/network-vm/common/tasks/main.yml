---
- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: Install required system packages
  apt:
    name:
      - curl
      - wget
      - git
      - ssh
      - python3
      - python3-pip
      - software-properties-common
      - docker.io
      - docker-compose
      - ca-certificates
      - gnupg
      - lsb-release
    state: present

- name: Ensure Docker service is running and enabled
  systemd:
    name: docker
    enabled: yes
    state: started

- name: Install Docker Compose v2
  shell: |
    curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
    chmod +x /usr/local/bin/docker-compose
  args:
    creates: /usr/local/bin/docker-compose

- name: Ensure timezone is set
  timezone:
    name: "{{ timezone | default('UTC') }}"

- name: Create shared directories
  file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  loop:
    - /opt/scripts
    - /var/log/myapp

- name: Disable unattended upgrades (optional)
  apt:
    name: unattended-upgrades
    state: absent
    purge: yes
