- name: Add Tailscale official APT repository key
  apt_key:
    url: https://pkgs.tailscale.com/stable/ubuntu/focal.noarmor.gpg
    state: present

- name: Add Tailscale official APT repository
  apt_repository:
    repo: "deb https://pkgs.tailscale.com/stable/ubuntu focal main"
    state: present

- name: Update apt cache after adding repo
  apt:
    update_cache: yes

- name: Install Tailscale
  apt:
    name: tailscale
    state: present
    
- name: Enable and start tailscaled service
  systemd:
    name: tailscaled
    enabled: yes
    state: started
    
- name: Authenticate with Tailscale
  command: "tailscale up --authkey={{ tailscale_authkey }}"
  args:
    creates: /var/lib/tailscale/tailscaled.state

- name: Wait for Tailscale to come online
  shell: tailscale status | grep '100.64'
  register: tailscale_status
  retries: 6
  delay: 5
  until: tailscale_status.stdout | length > 0
