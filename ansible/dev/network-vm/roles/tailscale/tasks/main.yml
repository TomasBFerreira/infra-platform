- name: Add Tailscale official APT repository key
  apt_key:
    url: https://pkgs.tailscale.com/stable/ubuntu/focal.noarmor.gpg
    state: present

- name: Add Tailscale official APT repository
  apt_repository:
    repo: "deb https://pkgs.tailscale.com/stable/ubuntu focal main"
    state: present

- name: Update apt cache after adding repo
  apt:
    update_cache: yes

- name: Install Tailscale
  apt:
    name: tailscale
    state: present

- name: Ensure tun module is loaded
  modprobe:
    name: tun
    state: present
  ignore_errors: yes
  register: modprobe_result

- name: Check if /dev/net/tun exists
  stat:
    path: /dev/net/tun
  register: tun_stat

- name: Create /dev/net directory if missing
  file:
    path: /dev/net
    state: directory
    mode: '0755'
  when: not tun_stat.stat.exists

- name: Create tun device if missing (Proxmox VE workaround)
  command: mknod /dev/net/tun c 10 200
  when: not tun_stat.stat.exists
  ignore_errors: yes

- name: Set tun device permissions
  file:
    path: /dev/net/tun
    mode: '0666'
  when: tun_stat.stat.exists or not tun_stat.stat.exists
    
- name: Enable and start tailscaled service
  systemd:
    name: tailscaled
    enabled: yes
    state: started

- name: Restart tailscaled service
  systemd:
    name: tailscaled
    state: restarted
    enabled: yes

- name: Check tailscaled service status and logs for debugging
  command: journalctl -u tailscaled --no-pager -n 50
  register: tailscaled_logs
  ignore_errors: yes

- debug:
    msg: "{{ tailscaled_logs.stdout }}"

- name: Wait for tailscaled to be active or activating
  command: systemctl is-active tailscaled
  register: tailscaled_status
  retries: 15
  delay: 5
  until: tailscaled_status.stdout in ['active', 'activating']
  ignore_errors: yes
  
- name: Authenticate with Tailscale
  command: "tailscale up --authkey={{ tailscale_authkey }}"
  args:
    creates: /var/lib/tailscale/tailscaled.state

- name: Wait for Tailscale to come online
  shell: tailscale status | grep '100.64'
  register: tailscale_status
  retries: 6
  delay: 5
  until: tailscale_status.stdout | length > 0
