---
- name: Check if qBittorrent Vault secret exists
  community.hashi_vault.hashi_vault:
    url: "{{ vault_addr }}"
    token: "{{ vault_token }}"
    secret: "secret/data/secret/qbittorrent"
  register: qbittorrent_secret
  ignore_errors: true

- name: Create qBittorrent Vault secret if missing
  when: qbittorrent_secret.failed
  block:
    - name: Generate random password
      community.general.password:
        length: 16
        special: true
      register: qbittorrent_generated_password

    - name: Write qBittorrent secret to Vault
      community.hashi_vault.hashi_vault_write:
        url: "{{ vault_addr }}"
        token: "{{ vault_token }}"
        path: "secret/data/secret/qbittorrent"
        data:
          data:
            username: "admin"
            password: "{{ qbittorrent_generated_password.password }}"

- name: Load qBittorrent Vault secret into variables
  community.hashi_vault.hashi_vault:
    url: "{{ vault_addr }}"
    token: "{{ vault_token }}"
    secret: "secret/data/secret/qbittorrent"
  register: qbittorrent_secret_final

- name: Set qBittorrent credentials as facts
  set_fact:
    qbittorrent_user: "{{ qbittorrent_secret_final.value.username }}"
    qbittorrent_password: "{{ qbittorrent_secret_final.value.password }}"
