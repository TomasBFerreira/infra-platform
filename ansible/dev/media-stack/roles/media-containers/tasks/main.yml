- name: Create media directories
  file:
    path: "{{ item }}"
    state: directory
    owner: 1000
    group: 1000
    mode: '0775'
  loop:
    - "{{ base_media_path }}/tv"
    - "{{ base_media_path }}/movies"
    - "{{ base_media_path }}/downloads/complete"
    - "{{ base_media_path }}/config/sonarr"
    - "{{ base_media_path }}/config/radarr"
    - "{{ base_media_path }}/config/prowlarr"
    - "{{ base_media_path }}/config/qbittorrent"
    - "{{ base_media_path }}/config/jellyfin"

- name: Deploy media stack containers
  community.docker.docker_container:
    name: "{{ item.name }}"
    image: "{{ item.image }}"
    state: started
    restart_policy: unless-stopped
    ports: "{{ item.ports | default(omit) }}"
    volumes: "{{ item.volumes | default(omit) }}"
    env:
      PUID: "1000"
      PGID: "1000"
      TZ: "{{ timezone }}"
      WEBUI_PORT: "{{ item.env.WEBUI_PORT | default(omit) }}"
      WEBUI_USER: "{{ item.env.WEBUI_USER | default(omit) }}"
      WEBUI_PASSWORD: "{{ item.env.WEBUI_PASSWORD | default(omit) }}"
  loop: "{{ media_containers }}"

- name: Wait for services to fully start
  wait_for:
    port: "{{ item }}"
    delay: 5
    timeout: 15
  with_items:
    - 8989
    - 7878
    - 9696
    - 8080
    - 8096

- name: Verify accessibility of exposed ports
  uri:
    url: "http://localhost:{{ item }}"
    status_code: [200, 302, 401]
    timeout: 10
  register: health_results
  loop:
    - 8989
    - 7878
    - 9696
    - 8080
    - 8096
  ignore_errors: yes

- name: Aggregate health check failures
  set_fact:
    failed_ports: "{{ health_results.results | selectattr('failed', 'defined') | selectattr('failed') | map(attribute='item') | list }}"

- name: Fail playbook if any port checks failed
  fail:
    msg: "Services on ports {{ failed_ports }} failed health check!"
  when: failed_ports | length > 0
