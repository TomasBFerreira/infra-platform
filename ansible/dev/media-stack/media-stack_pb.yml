---
- name: Media Stack Setup on Proxmox LXC Worker Node
  hosts: media-stack_worker
  become: true
  vars:
    vault_addr: "http://192.168.50.169:8200"
    vault_token: "{{ lookup('env', 'VAULT_TOKEN') }}"
    ssh_private_key: "{{ lookup('community.hashi_vault.hashi_vault', 'secret=secret/data/ssh_keys/media-stack_worker:private token=' + vault_token + ' url=' + vault_addr) }}"
    base_media_path: /mnt/media  # Removed duplicate
    timezone: "UTC"
    media_containers:
      - name: sonarr
        image: lscr.io/linuxserver/sonarr:latest
        ports:
          - "8989:8989"
        volumes:
          - "{{ base_media_path }}/config/sonarr:/config"
          - "{{ base_media_path }}/tv:/tv"
          - "{{ base_media_path }}/downloads/complete:/downloads"
      - name: radarr
        image: lscr.io/linuxserver/radarr:latest
        ports:
          - "7878:7878"
        volumes:
          - "{{ base_media_path }}/config/radarr:/config"
          - "{{ base_media_path }}/movies:/movies"
          - "{{ base_media_path }}/downloads/complete:/downloads"
      - name: prowlarr
        image: lscr.io/linuxserver/prowlarr:develop
        ports:
          - "9696:9696"
        volumes:
          - "{{ base_media_path }}/config/prowlarr:/config"
      - name: qbittorrent
        image: lscr.io/linuxserver/qbittorrent:latest
        ports:
          - "8080:8080"
          - "6881:6881"
          - "6881:6881/udp"
        env:
          WEBUI_PORT: "8080"
          WEBUI_USER: "admin"
          WEBUI_PASSWORD: "adminadmin"
        volumes:
          - "{{ base_media_path }}/config/qbittorrent:/config"
          - "{{ base_media_path }}/downloads/complete:/downloads"
      - name: jellyfin
        image: lscr.io/linuxserver/jellyfin:latest
        ports:
          - "8096:8096"
          - "8920:8920"
          - "1900:1900/udp"
          - "7359:7359/udp"
        volumes:
          - "{{ base_media_path }}/config/jellyfin:/config"
          - "{{ base_media_path }}/tv:/data/tvshows"
          - "{{ base_media_path }}/movies:/data/movies"

  tasks:
    - name: Install required system packages
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
        state: present
        update_cache: yes

    - name: Add Docker's official GPG key
      apt_key:
        url: https://download.docker.com/linux/debian/gpg
        state: present

    - name: Add Docker repository
      apt_repository:
        repo: "deb [arch=amd64] https://download.docker.com/linux/debian {{ ansible_distribution_release }} stable"
        state: present
        filename: docker-ce-stable

    - name: Install Docker packages
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
        state: present
        update_cache: yes

    - name: Ensure Docker is running and enabled
      service:
        name: docker
        state: started
        enabled: yes

    - name: Create media directories
      file:
        path: "{{ item }}"
        state: directory
        owner: 1000
        group: 1000
        mode: '0775'
      loop:
        - "{{ base_media_path }}/tv"
        - "{{ base_media_path }}/movies"
        - "{{ base_media_path }}/downloads/complete"
        - "{{ base_media_path }}/config/sonarr"
        - "{{ base_media_path }}/config/radarr"
        - "{{ base_media_path }}/config/prowlarr"
        - "{{ base_media_path }}/config/qbittorrent"
        - "{{ base_media_path }}/config/jellyfin"

    - name: Deploy media stack containers
      community.docker.docker_container:
        name: "{{ item.name }}"
        image: "{{ item.image }}"
        state: started
        restart_policy: unless-stopped
        ports: "{{ item.ports | default(omit) }}"
        volumes: "{{ item.volumes | default(omit) }}"
        env:
          PUID: "1000"
          PGID: "1000"
          TZ: "{{ timezone }}"
          WEBUI_PORT: "{{ item.env.WEBUI_PORT | default(omit) }}"
          WEBUI_USER: "{{ item.env.WEBUI_USER | default(omit) }}"
          WEBUI_PASSWORD: "{{ item.env.WEBUI_PASSWORD | default(omit) }}"
      loop: "{{ media_containers }}"

    - name: Wait for services to start
      pause:
        seconds: 10

    - name: Verify accessibility of exposed ports
      uri:
        url: "http://localhost:{{ item }}"
        return_content: no
        status_code: 200, 302, 401
        timeout: 10
      loop:
        - 8989
        - 7878
        - 9696
        - 8080
        - 8096
      register: service_check
      ignore_errors: yes

    - name: Display service statuses
      debug:
        msg: >
          Service on port {{ item.item }}: 
          {% if item.failed is defined and item.failed %}FAILED{% else %}OK{% endif %}
      loop: "{{ service_check.results }}"
