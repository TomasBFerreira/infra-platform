name: Infra Orchestration Pipeline

on:
  push:
    branches: [main]
    paths:
      - 'terraform/**'
      - 'ansible/**'
  pull_request:
    branches: [main]

env:
  VAULT_ADDR: http://192.168.50.169:8200
  VAULT_TOKEN: root
  TF_VAR_vault_token: root
  TF_VAR_proxmox_api_url: "https://192.168.50.2:8006/api2/json"
  TF_VAR_proxmox_user: "root@pam"
  TF_VAR_proxmox_password: "Tomtom22!"

jobs:
  secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Install Curl, Unzip, Vault CLI
        run: |
          apt-get update
          apt-get install -y curl wget unzip
          wget https://releases.hashicorp.com/vault/1.21.0/vault_1.21.0_linux_amd64.zip
          unzip vault_1.21.0_linux_amd64.zip
          mv vault /usr/local/bin/
          vault --version
      - name: Generate SSH Key if not present
        run: |
          mkdir -p ~/.ssh
          [ -f ~/.ssh/media-stack_worker_id_ed25519 ] || ssh-keygen -t ed25519 -N "" -f ~/.ssh/media-stack_worker_id_ed25519
      - name: Write SSH Key to Vault
        run: |
          vault kv put secret/ssh_keys/media-stack_worker \
            public=@$HOME/.ssh/media-stack_worker_id_ed25519.pub \
            private=@$HOME/.ssh/media-stack_worker_id_ed25519
        env:
          VAULT_TOKEN: "root"

  terraform:
    needs: secrets
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Install Terraform
        run: |
          apt-get update
          apt-get install -y wget unzip
          wget https://releases.hashicorp.com/terraform/1.6.4/terraform_1.6.4_linux_amd64.zip
          ls -lh terraform_1.6.4_linux_amd64.zip
          file terraform_1.6.4_linux_amd64.zip
          unzip -o terraform_1.6.4_linux_amd64.zip
          ls -lh
          mv terraform /usr/local/bin/
          ls -lh /usr/local/bin/terraform
          terraform -version
      - name: Terraform Init
        run: |
          cd terraform/media-stack
          terraform init
      - name: Terraform Plan
        run: |
          cd terraform/media-stack
          terraform plan
      - name: Terraform Apply
        run: |
          cd terraform/media-stack
          terraform apply -auto-approve

  ansible:
    needs: terraform
    runs-on: ubuntu-latest
    steps:
      - name: Install Ansible and dependencies
        run: |
          apt-get update
          apt-get install -y python3-pip jq
          pip3 install ansible hvac
          ansible --version
      - name: Retrieve SSH key from Vault
        run: |
          apt-get install -y wget unzip curl
          wget https://releases.hashicorp.com/vault/1.21.0/vault_1.21.0_linux_amd64.zip
          unzip vault_1.21.0_linux_amd64.zip
          mv vault /usr/local/bin/
          vault --version
          mkdir -p ~/.ssh
          vault kv get -field=private secret/ssh_keys/media-stack_worker > ~/.ssh/media-stack_worker_id_ed25519
          chmod 600 ~/.ssh/media-stack_worker_id_ed25519
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Run Ansible playbook
        run: |
          ansible-playbook -i inventory.yml ansible/media-stack/media-stack_pb.yml
