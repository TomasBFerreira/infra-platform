name: Deploy Vault LXC to Prod

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'terraform/prod/vault-lxc/**'
      - 'ansible/dev/vault-lxc/**'
      - '.github/workflows/deploy-vault-lxc.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    environment: production
    env:
      PVE_NODE: betsy
      LXC_TEMPLATE: local:vztmpl/ubuntu-22.04-standard_22.04-1_amd64.tar.zst
      LXC_ID: 310
      LXC_IP: 192.168.50.310/24
      LXC_GW: 192.168.50.1
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Terraform Init & Apply (container)
        env:
          TF_VAR_proxmox_api_url: ${{ secrets.PVE_API }}
          TF_VAR_proxmox_user: ${{ secrets.PVE_USER }}
          TF_VAR_proxmox_password: ${{ secrets.PVE_PASS }}
          TF_VAR_target_node: ${{ env.PVE_NODE }}
          TF_VAR_lxc_template: ${{ env.LXC_TEMPLATE }}
          TF_VAR_lxc_id: ${{ env.LXC_ID }}
          TF_VAR_lxc_ip: ${{ env.LXC_IP }}
          TF_VAR_lxc_gw: ${{ env.LXC_GW }}
          TF_VAR_ssh_public_keys: ${{ secrets.SSH_PUBLIC_KEYS }}
        run: |
          ./scripts/run-terraform.sh -chdir terraform/prod/vault-lxc init
          ./scripts/run-terraform.sh -chdir terraform/prod/vault-lxc apply -auto-approve

      - name: Ansible Playbook (container)
        env:
          ANSIBLE_HOST_KEY_CHECKING: 'False'
        run: |
          ./scripts/run-ansible.sh playbook -i ansible/dev/vault-lxc/inventory.ini ansible/dev/vault-lxc/vault-lxc_setup.yml
