name: Deploy Vault LXC to Prod

on:
  push:
    branches: [dev]
    paths:
      - 'terraform/prod/vault-lxc/**'
      - 'ansible/dev/vault-lxc/**'
      - '.github/workflows/deploy-vault-lxc.yml'
  pull_request:
    branches: [dev]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    env:
      PVE_NODE: betsy
      LXC_TEMPLATE: "100"
      LXC_ID: 310
      LXC_IP: 192.168.50.310/24
      LXC_GW: 192.168.50.1
    steps:
      - name: Set UID and GID env
        run: |
          echo "UID=$(id -u)" >> $GITHUB_ENV
          echo "GID=$(id -g)" >> $GITHUB_ENV

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Export Terraform variables
        run: |
          echo "TF_VAR_target_node=${{ env.PVE_NODE }}" >> $GITHUB_ENV
          echo "TF_VAR_lxc_template=${{ env.LXC_TEMPLATE }}" >> $GITHUB_ENV
          echo "TF_VAR_lxc_id=${{ env.LXC_ID }}" >> $GITHUB_ENV
          echo "TF_VAR_lxc_ip=${{ env.LXC_IP }}" >> $GITHUB_ENV
          echo "TF_VAR_lxc_gw=${{ env.LXC_GW }}" >> $GITHUB_ENV
          echo "TF_VAR_proxmox_api_url=${{ secrets.PVE_API }}" >> $GITHUB_ENV
          echo "TF_VAR_proxmox_user=${{ secrets.PVE_USER }}" >> $GITHUB_ENV
          echo "TF_VAR_proxmox_password=${{ secrets.PVE_PASS }}" >> $GITHUB_ENV
          echo "TF_VAR_ssh_public_keys=${{ secrets.SSH_PUBLIC_KEYS }}" >> $GITHUB_ENV

      - name: Terraform Init & Apply (container)
        run: |
          ./scripts/run-terraform.sh -chdir terraform/prod/vault-lxc init
          ./scripts/run-terraform.sh -chdir terraform/prod/vault-lxc apply -auto-approve

      - name: Ansible Playbook (container)
        env:
          ANSIBLE_HOST_KEY_CHECKING: 'False'
        run: |
          ./scripts/run-ansible.sh playbook -i ansible/dev/vault-lxc/inventory.ini ansible/dev/vault-lxc/vault-lxc_setup.yml
