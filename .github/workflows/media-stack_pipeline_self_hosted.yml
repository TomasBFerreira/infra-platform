name: Media-Stack Pipeline (Self-Hosted)

on:
  push:
    branches: [main]
    paths:
      - 'terraform/dev/media-stack/**'
      - 'ansible/dev/media-stack/**'
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  secrets:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate SSH Key if not present
        run: |
          mkdir -p ~/.ssh
          [ -f ~/.ssh/media-stack_worker_id_ed25519 ] || ssh-keygen -t ed25519 -N "" -f ~/.ssh/media-stack_worker_id_ed25519

      - name: Write SSH Key to Vault
        env:
          VAULT_ADDR: http://localhost:8200
          VAULT_TOKEN: myroot
        run: |
          echo "VAULT_ADDR = $VAULT_ADDR"
          vault kv put secret/ssh_keys/media-stack_worker \
            public=@$HOME/.ssh/media-stack_worker_id_ed25519.pub \
            private=@$HOME/.ssh/media-stack_worker_id_ed25519

  terraform:
    needs: secrets
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Debug workspace layout
        run: |
          pwd
          ls -l
          ls -l terraform/dev/media-stack

      - name: Terraform Init
        env:
          VAULT_ADDR: http://localhost:8200
          VAULT_TOKEN: myroot
          TF_VAR_proxmox_api_url: ${{ secrets.PVE_API }}
          TF_VAR_proxmox_user: ${{ secrets.PVE_USER }}
          TF_VAR_proxmox_password: ${{ secrets.PVE_PASS }}
          TF_VAR_vault_token: myroot
        run: |
          cd terraform/dev/media-stack
          terraform init

      - name: Terraform Plan
        env:
          VAULT_ADDR: http://localhost:8200
          VAULT_TOKEN: myroot
          TF_VAR_proxmox_api_url: ${{ secrets.PVE_API }}
          TF_VAR_proxmox_user: ${{ secrets.PVE_USER }}
          TF_VAR_proxmox_password: ${{ secrets.PVE_PASS }}
          TF_VAR_vault_token: myroot
        run: |
          cd terraform/dev/media-stack
          terraform plan

      - name: Terraform Apply
        if: github.ref == 'refs/heads/main'
        env:
          VAULT_ADDR: http://localhost:8200
          VAULT_TOKEN: myroot
          TF_VAR_proxmox_api_url: ${{ secrets.PVE_API }}
          TF_VAR_proxmox_user: ${{ secrets.PVE_USER }}
          TF_VAR_proxmox_password: ${{ secrets.PVE_PASS }}
          TF_VAR_vault_token: myroot
        run: |
          cd terraform/dev/media-stack
          terraform apply -auto-approve

  ansible:
    needs: terraform
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Ensure Ansible dependencies are available
        run: |
          # Install Ansible collections if needed
          cd /app/infra-platform
          ./scripts/run-ansible.sh galaxy collection install community.general community.hashi_vault || true

      - name: Retrieve SSH key from Vault
        env:
          VAULT_ADDR: http://localhost:8200
          VAULT_TOKEN: myroot
        run: |
          mkdir -p ~/.ssh
          vault kv get -field=private secret/ssh_keys/media-stack_worker > ~/.ssh/media-stack_worker_id_ed25519
          chmod 600 ~/.ssh/media-stack_worker_id_ed25519

      - name: Run Ansible playbook via container
        env:
          VAULT_ADDR: http://localhost:8200
          VAULT_TOKEN: myroot
          ANSIBLE_SSH_ARGS: "-o ConnectTimeout=30 -o ConnectionAttempts=3 -o ServerAliveInterval=15 -o ServerAliveCountMax=3"
        run: |
          # Ensure the SSH key has the correct permissions
          chmod 600 ~/.ssh/media-stack_worker_id_ed25519
          
          # Run the playbook via container
          cd /app/infra-platform
          ./scripts/run-ansible.sh playbook \
            -i ansible/dev/media-stack/inventory.ini \
            -v \
            --private-key ~/.ssh/media-stack_worker_id_ed25519 \
            ansible/dev/media-stack/media-stack_setup.yml
