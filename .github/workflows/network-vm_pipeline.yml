name: Network-VM Pipeline

on:
  push:
    branches: [main]
    paths:
      - 'terraform/dev/network-vm/**'
      - 'ansible/dev/network-vm/**'
  workflow_dispatch:

# Set environment variables that can be used across jobs
env:
  TF_VERSION: 1.6.4
  VAULT_VERSION: 1.21.0
  TAILSCALE_VERSION: 1.56.1
  PVE_NODE: betsy
  VMID: '220'

# Define job outputs to share data between jobs
jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      tf_plan: ${{ steps.plan.outputs.tf_plan }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Terraform Init
        id: init
        working-directory: terraform/dev/network-vm
        env:
<<<<<<< HEAD
          TF_VAR_proxmox_api_url: ${{ secrets.PROXMOX_API_URL }}
          TF_VAR_proxmox_user: ${{ secrets.PROXMOX_USER }}
          TF_VAR_proxmox_password: ${{ secrets.PROXMOX_PASSWORD }}
          VAULT_ADDR: ${{ secrets.VAULT_ADDR || 'http://localhost:8200' }}
          VAULT_NAMESPACE: ${{ secrets.VAULT_NAMESPACE || '' }}
=======
          TF_VAR_pve_api: ${{ secrets.PVE_API }}
          TF_VAR_pve_user: ${{ secrets.PVE_USER }}
          TF_VAR_pve_pass: ${{ secrets.PVE_PASS }}
          TF_VAR_ssh_user: ${{ secrets.SSH_USER }}
>>>>>>> dev
        run: |
          terraform init -input=false

      - name: Terraform Plan
        id: plan
        working-directory: terraform/dev/network-vm
        env:
<<<<<<< HEAD
          TF_VAR_proxmox_api_url: ${{ secrets.PROXMOX_API_URL }}
          TF_VAR_proxmox_user: ${{ secrets.PROXMOX_USER }}
          TF_VAR_proxmox_password: ${{ secrets.PROXMOX_PASSWORD }}
          VAULT_ADDR: ${{ secrets.VAULT_ADDR || 'http://localhost:8200' }}
          VAULT_NAMESPACE: ${{ secrets.VAULT_NAMESPACE || '' }}
=======
          TF_VAR_pve_api: ${{ secrets.PVE_API }}
          TF_VAR_pve_user: ${{ secrets.PVE_USER }}
          TF_VAR_pve_pass: ${{ secrets.PVE_PASS }}
          TF_VAR_ssh_user: ${{ secrets.SSH_USER }}
>>>>>>> dev
        run: |
          terraform plan -no-color -input=false -out=tfplan
          echo "tf_plan=$(base64 -w0 tfplan)" >> $GITHUB_OUTPUT

  terraform-apply:
    needs: setup
    if: github.ref == 'refs/heads/main' && needs.setup.outputs.tf_plan != ''
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

<<<<<<< HEAD
      - name: Setup Vault
        uses: hashicorp/vault-action@v2
        with:
          url: ${{ secrets.VAULT_ADDR }}
          method: jwt
          jwtGithubAudience: ${{ secrets.VAULT_AUDIENCE }}
          secrets: |
            secret/data/network-vm PVE_CREDS | PVE_USER PVE_PASS ;
            secret/data/network-vm/ssh SSH_PRIVATE_KEY | SSH_PRIVATE_KEY ;

      - name: Cleanup Proxmox VM via API
        env:
          PVE_API: ${{ secrets.PVE_API }}
          PVE_USER: ${{ env.PVE_USER }}
          PVE_PASS: ${{ env.PVE_PASS }}
=======
      - name: Cleanup Proxmox VM via API
        env:
          PVE_API: ${{ secrets.PVE_API }}
          PVE_USER: ${{ secrets.PVE_USER }}
          PVE_PASS: ${{ secrets.PVE_PASS }}
>>>>>>> dev
          PVE_NODE: ${{ env.PVE_NODE }}
          VMID: ${{ env.VMID }}
        run: |
          # Cleanup script will be called here
          echo "VM cleanup would happen here"

      - name: Terraform Apply
        working-directory: terraform/dev/network-vm
        env:
<<<<<<< HEAD
          TF_VAR_proxmox_api_url: ${{ secrets.PROXMOX_API_URL }}
          TF_VAR_proxmox_user: ${{ secrets.PROXMOX_USER }}
          TF_VAR_proxmox_password: ${{ secrets.PROXMOX_PASSWORD }}
          VAULT_ADDR: ${{ secrets.VAULT_ADDR || 'http://localhost:8200' }}
          VAULT_NAMESPACE: ${{ secrets.VAULT_NAMESPACE || '' }}
        run: |
          terraform apply -auto-approve

  vault-secrets:
    needs: terraform-apply
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Vault
        uses: hashicorp/vault-action@v2
        with:
          url: ${{ secrets.VAULT_ADDR }}
          method: jwt
          jwtGithubAudience: ${{ secrets.VAULT_AUDIENCE }}
          secrets: |
            secret/data/network-vm env | ;
            secret/data/network-vm/ssh SSH_PRIVATE_KEY | SSH_PRIVATE_KEY ;

      - name: Generate Vault secrets for network VM
        run: |
          chmod +x scripts/dev/network-vm/vault-generate-secrets.sh
          scripts/dev/network-vm/vault-generate-secrets.sh

  ansible:
    needs: [terraform-apply, vault-secrets]
=======
          TF_VAR_pve_api: ${{ secrets.PVE_API }}
          TF_VAR_pve_user: ${{ secrets.PVE_USER }}
          TF_VAR_pve_pass: ${{ secrets.PVE_PASS }}
          TF_VAR_ssh_user: ${{ secrets.SSH_USER }}
        run: |
          terraform apply -auto-approve

  # Vault setup will be added later when Vault is ready
  # vault-secrets:
  #   needs: terraform-apply
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Setup Vault
  #       uses: hashicorp/vault-action@v2
  #       with:
  #         url: ${{ secrets.VAULT_ADDR }}
  #         method: jwt
  #         jwtGithubAudience: ${{ secrets.VAULT_AUDIENCE }}
  #         secrets: |
  #           secret/data/network-vm env | ;
  #           secret/data/network-vm/ssh SSH_PRIVATE_KEY | SSH_PRIVATE_KEY ;
  #
  #     - name: Generate Vault secrets for network VM
  #       run: |
  #         chmod +x scripts/dev/network-vm/vault-generate-secrets.sh
  #         scripts/dev/network-vm/vault-generate-secrets.sh

  ansible:
    needs: terraform-apply
>>>>>>> dev
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Ansible and Python deps
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip python3-venv jq netcat-openbsd sshpass
          python3 -m venv /tmp/ansible-venv
          source /tmp/ansible-venv/bin/activate
          pip install --upgrade pip wheel
          pip install ansible hvac
          ansible-galaxy collection install community.hashi_vault community.docker

<<<<<<< HEAD
      - name: Setup Vault for Ansible
        uses: hashicorp/vault-action@v2
        with:
          url: ${{ secrets.VAULT_ADDR }}
          method: jwt
          jwtGithubAudience: ${{ secrets.VAULT_AUDIENCE }}
          secrets: |
            secret/data/network-vm/ssh SSH_PRIVATE_KEY | SSH_PRIVATE_KEY ;
=======
      # Vault setup will be added later when Vault is ready
      # - name: Setup Vault for Ansible
      #   uses: hashicorp/vault-action@v2
      #   with:
      #     url: ${{ secrets.VAULT_ADDR }}
      #     method: jwt
      #     jwtGithubAudience: ${{ secrets.VAULT_AUDIENCE }}
      #     secrets: |
      #       secret/data/network-vm/ssh SSH_PRIVATE_KEY | SSH_PRIVATE_KEY ;
>>>>>>> dev

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/network_vm_id_ed25519
          chmod 600 ~/.ssh/network_vm_id_ed25519
          echo "$TF_OUTPUT_IP" > /tmp/vm_ip.txt
          echo "$TF_OUTPUT_IP $(cat /tmp/vm_ip.txt) $(hostname)" | sudo tee -a /etc/hosts

      - name: Wait for SSH to be ready
        run: |
          for i in {1..30}; do
            if nc -z -w3 $TF_OUTPUT_IP 22; then
              echo "SSH is up! Proceeding."
              exit 0
            fi
            echo "Waiting for SSHâ€¦"
            sleep 5
          done
          echo "SSH is NOT up after waiting. Exiting."
          exit 1

      - name: Run Ansible playbook
        env:
          ANSIBLE_HOST_KEY_CHECKING: false
          ANSIBLE_FORCE_COLOR: 1
          TF_OUTPUT_IP: ${{ steps.get-outputs.outputs.vm_ip }}
        run: |
          source /tmp/ansible-venv/bin/activate
          ansible-playbook \
            -i "$TF_OUTPUT_IP," \
            -u ${{ secrets.SSH_USER }} \
            --private-key ~/.ssh/network_vm_id_ed25519 \
            ansible/dev/network-vm/network-vm_setup.yml

  tailscale:
    needs: ansible
    runs-on: ubuntu-latest
    steps:
      - name: Install Tailscale
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TAILSCALE_OAUTH_SECRET }}
          authkey: ${{ secrets.TAILSCALE_AUTH_KEY }}
          hostname: network-vm-pipeline
          tags: tag:ci,env:prod
