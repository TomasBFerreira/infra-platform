name: Dev Infrastructure Management (Cached)

on:
  workflow_dispatch:
  push:
    branches: [dev]
    paths:
      - 'terraform/dev/**'
      - 'ansible/dev/**'
      - '.github/workflows/dev-infrastructure-cached.yml'

env:
  TF_VERSION: 1.6.4

jobs:
  detect-changes:
    runs-on: self-hosted
    outputs:
      terraform_changed: ${{ steps.changes.outputs.terraform }}
      ansible_changed: ${{ steps.changes.outputs.ansible }}
      media_stack_changed: ${{ steps.changes.outputs.media_stack }}
      network_vm_changed: ${{ steps.changes.outputs.network_vm }}
      infra_lxc_changed: ${{ steps.changes.outputs.infra_lxc }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Detect file changes
        id: changes
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "terraform=true" >> $GITHUB_OUTPUT
            echo "ansible=true" >> $GITHUB_OUTPUT
            echo "media_stack=${{ github.event.inputs.deploy_media_stack }}" >> $GITHUB_OUTPUT
            echo "network_vm=${{ github.event.inputs.deploy_network_vm }}" >> $GITHUB_OUTPUT
            echo "infra_lxc=${{ github.event.inputs.deploy_infra_lxc }}" >> $GITHUB_OUTPUT
          else
            echo "terraform=$(git diff --name-only ${{ github.event.before }} ${{ github.event.after }} 2>/dev/null | grep -E '^terraform/dev/' | wc -l > /dev/null && echo true || echo false)" >> $GITHUB_OUTPUT
            echo "ansible=$(git diff --name-only ${{ github.event.before }} ${{ github.event.after }} 2>/dev/null | grep -E '^ansible/dev/' | wc -l > /dev/null && echo true || echo false)" >> $GITHUB_OUTPUT
            echo "media_stack=$(git diff --name-only ${{ github.event.before }} ${{ github.event.after }} 2>/dev/null | grep -E '^(terraform/dev/media-stack|ansible/dev/media-stack)' | wc -l > /dev/null && echo true || echo false)" >> $GITHUB_OUTPUT
            echo "network_vm=$(git diff --name-only ${{ github.event.before }} ${{ github.event.after }} 2>/dev/null | grep -E '^(terraform/dev/network-vm|ansible/dev/network-vm)' | wc -l > /dev/null && echo true || echo false)" >> $GITHUB_OUTPUT
            echo "infra_lxc=$(git diff --name-only ${{ github.event.before }} ${{ github.event.after }} 2>/dev/null | grep -E '^(terraform/dev/infra-lxc|ansible/dev/infra-lxc)' | wc -l > /dev/null && echo true || echo false)" >> $GITHUB_OUTPUT
          fi

  build-ansible-image:
    needs: detect-changes
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Build and tag Ansible image (cached)
        run: |
          cd /app/infra-platform
          docker compose build ansible
          docker tag custom-ansible:latest custom-ansible:ci

# ...existing code for terraform and ansible jobs, just like in dev-infrastructure.yml, but referencing build-ansible-image as a dependency...
