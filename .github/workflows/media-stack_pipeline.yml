name: Media-Stack pipeline

on:
  push:
    branches: [main]
    paths:
      - 'terraform/**'
      - 'ansible/**'
  pull_request:
    branches: [main]

jobs:
  secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Install Curl, Unzip, Vault CLI
        run: |
          apt-get update
          apt-get install -y curl wget unzip
          wget https://releases.hashicorp.com/vault/1.21.0/vault_1.21.0_linux_amd64.zip
          unzip vault_1.21.0_linux_amd64.zip
          sudo mv vault /usr/local/bin/
          vault --version
      - name: Generate SSH Key if not present
        run: |
          mkdir -p ~/.ssh
          [ -f ~/.ssh/media-stack_worker_id_ed25519 ] || ssh-keygen -t ed25519 -N "" -f ~/.ssh/media-stack_worker_id_ed25519
      - name: Write SSH Key to Vault
        env:
          VAULT_ADDR: http://192.168.50.169:8200
          VAULT_TOKEN: root
        run: |
          echo "VAULT_ADDR = $VAULT_ADDR"
          echo "VAULT_TOKEN = $VAULT_TOKEN"
          vault kv put secret/ssh_keys/media-stack_worker \
            public=@$HOME/.ssh/media-stack_worker_id_ed25519.pub \
            private=@$HOME/.ssh/media-stack_worker_id_ed25519

  terraform:
    needs: secrets
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Debug workspace layout
        run: |
          pwd
          ls -l
          ls -l terraform
          ls -l terraform/dev/media-stack
      - name: Install Terraform
        run: |
          apt-get update
          apt-get install -y wget unzip
          mkdir -p /tmp/terraform-bin
          cd /tmp/terraform-bin
          wget https://releases.hashicorp.com/terraform/1.6.4/terraform_1.6.4_linux_amd64.zip
          unzip terraform_1.6.4_linux_amd64.zip
          sudo mv terraform /usr/local/bin/
          terraform -version
          cd -
      - name: Debug pwd before Terraform steps
        run: |
          pwd
          ls -l
          ls -l terraform/dev/media-stack
      - name: Terraform Init
        env:
          VAULT_ADDR: http://192.168.50.169:8200
          VAULT_TOKEN: root
          TF_VAR_proxmox_api_url: http://192.168.50.2:8006/api2/json
          TF_VAR_proxmox_user: root@pam
          TF_VAR_proxmox_password: Tomtom22!
        run: |
          cd terraform/dev/media-stack
          terraform init
      - name: Terraform Plan
        env:
          VAULT_ADDR: http://192.168.50.169:8200
          VAULT_TOKEN: root
          TF_VAR_proxmox_api_url: http://192.168.50.2:8006/api2/json
          TF_VAR_proxmox_user: root@pam
          TF_VAR_proxmox_password: Tomtom22!
          TF_VAR_vault_token: root
        run: |
          cd terraform/dev/media-stack
          terraform plan
      - name: Terraform Apply
        env:
          VAULT_ADDR: http://192.168.50.169:8200
          VAULT_TOKEN: root
          TF_VAR_proxmox_api_url: http://192.168.50.2:8006/api2/json
          TF_VAR_proxmox_user: root@pam
          TF_VAR_proxmox_password: Tomtom22!
          TF_VAR_vault_token: root
        run: |
          cd terraform/dev/media-stack
          terraform apply -auto-approve

  ansible:
    needs: terraform
    runs-on: ubuntu-latest
    steps:
      - name: Install Ansible and dependencies (virtualenv)
        run: |
          apt-get update
          apt-get install -y python3-pip python3-venv jq git
          python3 -m venv /tmp/ansible-venv
          source /tmp/ansible-venv/bin/activate
          pip install --upgrade pip wheel
          pip install ansible hvac
          
          # Install only the required collections
          ansible-galaxy collection install community.general --force
          
          # Create a simple ansible.cfg
          mkdir -p /etc/ansible
          echo '[defaults]' > /etc/ansible/ansible.cfg
          echo 'host_key_checking = False' >> /etc/ansible/ansible.cfg
          echo 'timeout = 60' >> /etc/ansible/ansible.cfg
      - name: Retrieve SSH key from Vault
        env:
          VAULT_ADDR: http://192.168.50.169:8200
          VAULT_TOKEN: root
        run: |
          apt-get install -y wget unzip curl
          wget https://releases.hashicorp.com/vault/1.21.0/vault_1.21.0_linux_amd64.zip
          unzip vault_1.21.0_linux_amd64.zip
          sudo mv vault /usr/local/bin/
          vault --version
          mkdir -p ~/.ssh
          vault kv get -field=private secret/ssh_keys/media-stack_worker > ~/.ssh/media-stack_worker_id_ed25519
          chmod 600 ~/.ssh/media-stack_worker_id_ed25519
      - name: Check for SSH key file and path
        run: |
          echo "HOME is $HOME"
          ls -l $HOME/.ssh/
          cat $HOME/.ssh/media-stack_worker_id_ed25519 || true
          cat $HOME/.ssh/media-stack-worker_id_ed25519 || true
      - name: Check SSH port connectivity
        run: |
          apt-get update
          apt-get install -y netcat-openbsd
          nc -zv 192.168.50.200 22 || echo "Port 22 unreachable"
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Run Ansible playbook with debug info
        env:
          VAULT_ADDR: http://192.168.50.169:8200
          VAULT_TOKEN: root
          ANSIBLE_COLLECTIONS_PATH: /tmp/ansible-collections
          ANSIBLE_SSH_ARGS: "-o ConnectTimeout=30 -o ConnectionAttempts=3 -o ServerAliveInterval=15 -o ServerAliveCountMax=3"
        run: |
          source /tmp/ansible-venv/bin/activate
          
          # Ensure the SSH key has the correct permissions
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          chmod 600 ~/.ssh/media-stack_worker_id_ed25519
          
          # Debug information
          echo "=== Debug Information ==="
          echo "Current directory: $(pwd)"
          echo "Ansible version: $(ansible --version | head -1)"
          echo "Python version: $(python3 --version)"
          echo "SSH key path: $HOME/.ssh/media-stack_worker_id_ed25519"
          echo "SSH key permissions: $(ls -l $HOME/.ssh/media-stack_worker_id_ed25519)"
          echo "Inventory file contents:"
          cat ansible/dev/media-stack/inventory.ini || echo "No inventory.ini found"
          echo "======================="
          
          # Test SSH connection
          echo "=== Testing SSH connection ==="
          ssh -i ~/.ssh/media-stack_worker_id_ed25519 -o StrictHostKeyChecking=no root@192.168.50.200 'echo "SSH connection successful!"' || echo "SSH connection failed"
          
          # Run the playbook with verbose output and timeout
          ANSIBLE_COMMAND_TIMEOUT=300 \
          ANSIBLE_SSH_RETRIES=3 \
          ansible-playbook \
            -i ansible/dev/media-stack/inventory.ini \
            -vvvv \
            --private-key ~/.ssh/media-stack_worker_id_ed25519 \
            -e "ansible_ssh_private_key_file=~/.ssh/media-stack_worker_id_ed25519" \
            ansible/dev/media-stack/media-stack_setup.yml
            
          # If playbook fails, collect debug info
          if [ $? -ne 0 ]; then
            echo "=== Playbook failed, collecting debug info ==="
            ansible -i ansible/dev/media-stack/inventory.ini all -m ping -vvvv \
              --private-key ~/.ssh/media-stack_worker_id_ed25519
            echo "SSH debug info:"
            ssh -v -i ~/.ssh/media-stack_worker_id_ed25519 -o StrictHostKeyChecking=no root@192.168.50.200 exit || true
            echo "============================================"
            exit 1
          fi
